<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaka Player - JSON Loaded</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            background: #000; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        #shaka-wrapper { 
            position: absolute; 
            inset: 0; 
            width: 100%; 
            height: 100%; 
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            background: #000; 
            object-fit: contain; 
        }

        /* Hide default loading spinner if you prefer a clean look */
        .shaka-spinner-container { display: none !important; }

        /* Error Overlay Style */
        #error-display {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(255, 0, 0, 0.7);
            padding: 20px;
            border-radius: 8px;
            z-index: 100;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="shaka-wrapper" class="shaka-video-container">
        <video id="video-element" autoplay playsinline preload="metadata" poster="https://web.cricfoot.net/logo.png"></video>
        <div id="error-display">Stream Error: Failed to load content.</div>
    </div>

    <script>
        async function initApp() {
            // Install polyfills to patch browser incompatibilities
            shaka.polyfill.installAll();

            if (!shaka.Player.isBrowserSupported()) {
                alert('Browser not supported!');
                return;
            }

            const video = document.getElementById('video-element');
            const container = document.getElementById('shaka-wrapper');
            const player = new shaka.Player(video);
            const ui = new shaka.ui.Overlay(player, container, video);
            
            // UI Configuration
            const uiConfig = {
                'controlPanelElements': ['play_pause', 'time_and_duration', 'spacer', 'mute', 'volume', 'fullscreen', 'overflow_menu'],
                'addSeekBar': true
            };
            ui.configure(uiConfig);

            try {
                // 1. Fetch the external JSON playlist
                // Note: File must be in the same directory or have CORS enabled
                const response = await fetch('playlist.json');
                if (!response.ok) throw new Error("Could not load playlist.json");
                
                const playlist = await response.json();

                // 2. Identify channel from URL (e.g., index.html?id=bein1)
                const urlParams = new URLSearchParams(window.location.search);
                const channelId = urlParams.get('id') || "primehindi";
                const selected = playlist[channelId];

                if (!selected) {
                    console.error("Channel ID not found in JSON data.");
                    return;
                }

                // 3. Player Configuration (Stability Focus)
                player.configure({
                    streaming: {
                        lowLatencyMode: false,
                        bufferingGoal: 30,
                        rebufferingGoal: 10,
                        jumpLargeGaps: true,
                        useNativeHlsOnSafari: true
                    },
                    manifest: {
                        retryParameters: { maxAttempts: 5, baseDelay: 1000 }
                    },
                    drm: {
                        clearKeys: selected.clearKeys || {}
                    }
                });

                // Listen for errors
                player.addEventListener('error', (event) => {
                    console.error('Shaka Error:', event.detail);
                    document.getElementById('error-display').style.display = 'block';
                });

                // 4. Load the URL from JSON
                await player.load(selected.url.trim());
                console.log("Stream loaded successfully:", channelId);

            } catch (e) {
                console.error("Initialization Error:", e);
            }
        }

        // Initialize when UI is ready
        document.addEventListener('shaka-ui-loaded', initApp);
        // Fallback for direct loads
        if (document.readyState === 'complete') { initApp(); }
    </script>
</body>
</html>
